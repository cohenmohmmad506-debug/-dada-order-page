<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§å¤§æé€Ÿä¸‹å• - VIPä¸“å±é€šé“</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f5f7;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .header {
            background-color: #0052cc;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 12px;
            position: relative;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #555;
            margin-bottom: 4px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 15px;
        }

        .form-control:focus {
            outline: none;
            border-color: #0052cc;
        }

        .readonly-input {
            background-color: #f9f9f9;
            color: #888;
            border-color: #eee;
        }

        .btn-submit {
            width: 100%;
            background-color: #0052cc;
            color: white;
            border: none;
            padding: 14px;
            font-size: 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 82, 204, 0.2);
        }

        .btn-submit:active {
            background-color: #003d99;
            transform: translateY(1px);
        }

        .history-list {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 10;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 150px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="header">ğŸ“¦ å¤§å¤§æé€Ÿä¸‹å•</div>

    <div class="container">
        <div class="card">
            <div class="card-title">ğŸ›¡ï¸ ä¸“å±å•å·ä¸å‘ä»¶äºº</div>
            <div class="form-group">
                <label>é€è´§å•å· (ç³»ç»Ÿä¼šè‡ªåŠ¨é€’å¢)</label>
                <input type="text" id="orderNumber" class="form-control" placeholder="ä¾‹å¦‚: 001">
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;">
                    <input type="text" id="senderName" class="form-control readonly-input" placeholder="å‘ä»¶äºº" readonly>
                </div>
                <div class="form-group" style="flex: 1;">
                    <input type="text" id="senderPhone" class="form-control readonly-input" placeholder="ç”µè¯" readonly>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“ æ”¶ä»¶äººä¿¡æ¯</div>
            <div class="form-group">
                <label>æ”¶ä»¶äººå§“å/å…¬å¸ (ç‚¹å‡»æŸ¥çœ‹å†å²)</label>
                <input type="text" id="receiverName" class="form-control" placeholder="è¯·è¾“å…¥æ”¶ä»¶æ–¹åç§°" autocomplete="off"
                    onfocus="showHistory()">
                <div id="historyBox" class="history-list"></div>
            </div>
            <div class="form-group">
                <input type="tel" id="receiverPhone" class="form-control" placeholder="æ”¶ä»¶äººç”µè¯">
            </div>
            <div class="form-group">
                <input type="text" id="receiverAddress" class="form-control" placeholder="æ”¶ä»¶è¯¦ç»†åœ°å€ (çœå¸‚åŒº-è¡—é“)">
            </div>
        </div>

        <div class="card">
            <div class="card-title">âš–ï¸ ä¸šåŠ¡ä¸è´§ç‰©ä¿¡æ¯</div>
            <div class="form-group">
                <label>è¿è¾“æ–¹å¼</label>
                <select id="transportMethod" class="form-control">
                    <option value="é™†è¿" selected>ğŸšš é™†è¿ (é»˜è®¤)</option>
                    <option value="ç©ºè¿">âœˆï¸ ç©ºè¿</option>
                    <option value="æµ·è¿">ğŸš¢ æµ·è¿</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" id="itemName" class="form-control" placeholder="ç‰©å“åç§° (ä¾‹: çº¸ç®±/é…ä»¶)">
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;">
                    <input type="number" step="0.01" id="itemWeight" class="form-control" placeholder="é‡é‡KG (é€‰å¡«)">
                </div>
                <div class="form-group" style="flex: 1;">
                    <input type="number" step="0.01" id="itemVolume" class="form-control" placeholder="ä½“ç§¯mÂ³ (é€‰å¡«)">
                </div>
            </div>
            <div class="form-group">
                <input type="number" step="0.01" id="unloadFee" class="form-control" placeholder="å¸è´§è´¹ (å…ƒ/é€‰å¡«ï¼Œé»˜è®¤0)">
            </div>
        </div>

        <button class="btn-submit" onclick="submitOrder()">ğŸš€ ç¡®è®¤ä¸‹å•ï¼Œå‘¼å«å–ä»¶</button>
    </div>

    <script>
        function incrementString(str) {
            return str.replace(/\d+$/, function (n) {
                return String(parseInt(n, 10) + 1).padStart(n.length, '0');
            });
        }

        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            document.getElementById('senderName').value = urlParams.get('s_name') || 'æ•£å®¢(æœªç»‘å®š)';
            document.getElementById('senderPhone').value = urlParams.get('s_phone') || 'è¯·ç»‘å®š';
            const savedOrderNum = localStorage.getItem('dada_last_order_num');
            if (savedOrderNum) {
                document.getElementById('orderNumber').value = incrementString(savedOrderNum);
            } else {
                document.getElementById('orderNumber').value = '001';
            }
        };

        function showHistory() {
            const historyBox = document.getElementById('historyBox');
            const history = JSON.parse(localStorage.getItem('dada_history')) || [];
            if (history.length === 0) return;
            historyBox.innerHTML = '';
            history.forEach(item => {
                let div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<b>${item.name}</b> <span>${item.phone} | ${item.address}</span>`;
                div.onclick = function () {
                    document.getElementById('receiverName').value = item.name;
                    document.getElementById('receiverPhone').value = item.phone;
                    document.getElementById('receiverAddress').value = item.address;
                    historyBox.style.display = 'none';
                };
                historyBox.appendChild(div);
            });
            historyBox.style.display = 'block';
        }

        document.addEventListener('click', function (e) {
            if (e.target.id !== 'receiverName') {
                document.getElementById('historyBox').style.display = 'none';
            }
        });

        async function submitOrder() {
            const orderNum = document.getElementById('orderNumber').value;
            const rName = document.getElementById('receiverName').value;
            if (!orderNum || !rName) {
                alert("âš ï¸ è¯·å¡«å†™å•å·å’Œæ”¶ä»¶äººï¼");
                return;
            }

            // ä¿å­˜å†å²è®°å½•å’Œå•å·é€’å¢ï¼ˆä½ åŸæ¥çš„ä»£ç ï¼Œä¿ç•™ï¼‰
            localStorage.setItem('dada_last_order_num', orderNum);
            let history = JSON.parse(localStorage.getItem('dada_history')) || [];
            history = history.filter(item => item.name !== rName);
            history.unshift({ name: rName, phone: document.getElementById('receiverPhone').value, address: document.getElementById('receiverAddress').value });
            if (history.length > 5) history.pop();
            localStorage.setItem('dada_history', JSON.stringify(history));

            // æŒ‰é’®åé¦ˆ
            const btn = document.querySelector('.btn-submit');
            btn.innerHTML = "â³ ç»ˆææ ¸æ­¦å™¨ä¼ è¾“ä¸­...";
            btn.style.backgroundColor = "#ff9900";

            // æ”¶é›†è¡¨å•æ•°æ®
            const orderData = {
                "é€è´§å•å·": orderNum,
                "å‘ä»¶äºº": document.getElementById('senderName').value || 'æ•£å®¢',
                "å‘ä»¶ç”µè¯": document.getElementById('senderPhone').value || 'æ— ',
                "æ”¶ä»¶äºº": rName,
                "æ”¶ä»¶ç”µè¯": document.getElementById('receiverPhone').value || 'æ— ',
                "æ”¶ä»¶åœ°å€": document.getElementById('receiverAddress').value || 'æ— ',
                "è¿è¾“æ–¹å¼": document.getElementById('transportMethod').value,
                "ç‰©å“åç§°": document.getElementById('itemName').value || 'æœªå¡«',
                "é‡é‡KG": document.getElementById('itemWeight').value || '0',
                "ä½“ç§¯m3": document.getElementById('itemVolume').value || '0',
                "å¸è´§è´¹": document.getElementById('unloadFee').value || '0',
                "ä¸‹å•æ—¶é—´": new Date().toLocaleString()
            };

            try {
                // è¿™é‡Œæ›¿æ¢æˆä½ çš„ Worker åœ°å€ï¼ï¼ï¼
                const WORKER_URL = 'https://dada-order-relay.cohenmohmmad506.workers.dev';

                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // å¦‚æœä»¥ååŠ äº† token éªŒè¯ï¼Œå–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šå¹¶å¡«ä¸Šä½ çš„ token
                        // 'Authorization': 'Bearer ä½ è‡ªå·±è®¾å®šçš„token'
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    alert(`âœ… æ•°æ®å‘å°„æˆåŠŸï¼\nå•å· ${orderNum} å·²å®Œç¾æ¨é€ï¼`);
                } else {
                    const errText = await response.text();
                    alert(`âŒ å‘é€å¤±è´¥ï¼š${errText}`);
                }
            } catch (err) {
                alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + err.message);
            } finally {
                window.location.reload();
            }
        }
    </script>
</body>

</html>